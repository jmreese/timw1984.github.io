<!DOCTYPE html>
<html>
  <head>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>NOAA</title>
	<link rel="stylesheet" href="https://js.arcgis.com/3.12/dijit/themes/claro/claro.css"/>
    <link rel="stylesheet" href="https://js.arcgis.com/3.13/esri/css/esri.css"/>
	<link rel="stylesheet" type="text/css" href="https://timw1984.github.io/agsjs/css/agsjs.css" />

    <style>
    html, body{
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 1px;
        font-family: helvetica, arial, sans-serif;
        font-size: 90%;
		overflow: hidden;
    }
    #borderContainer {
		width: 100%;
		height: 100%;
    }
	#leftPane {
      width: 20%;
    }
	#bottomPane {
		width: 100%;
    }
	#mapCanvas {
		width: 100%;
		height: 100%;
    }
	#map {
		width: 100%;
		height: 100%;
    }

    </style>
	<script type="text/javascript">

                  var dojoConfig = { 
                    paths:	{
                            agsjs: 'https://timw1984.github.io/agsjs' 
							}
                  };
                             
     </script>

    <script src="https://js.arcgis.com/3.13/"></script>
    <script>
      var map;
      require(["esri/map", "esri/geometry/Multipoint","dojo/_base/array","esri/layers/ArcGISTiledMapServiceLayer", "dojo/parser", "agsjs/dijit/TOC","dojo/_base/connect","dojo/dom", "dojo/parser","dojo/on", "dojo/_base/Color","dijit/form/Button","esri/layers/FeatureLayer","dojo/dom-construct",
			"esri/config","esri/tasks/query","esri/tasks/QueryTask","esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleFillSymbol","esri/symbols/SimpleMarkerSymbol","esri/geometry/geometryEngine",
			"dijit/layout/BorderContainer","dijit/layout/ContentPane","dijit/layout/AccordionContainer","dijit/layout/ContentPane", "dijit/layout/AccordionContainer","dijit/form/TextBox","dojo/domReady!"], 
	  function(Map,Multipoint,arrayUtils,ArcGISTiledMapServiceLayer, parser,TOC,connect,  dom, parser, on,Color, Button, FeatureLayer,domConstruct,
	  esriConfig,Query,QueryTask,SimpleLineSymbol,SimpleFillSymbol,SimpleMarkerSymbol,geometryEngine) {
	  
	  var NewLayer, toc,currentLayer,currentDiv,previouseDiv, toc2;
	  var selectedCity = [];
	  var click = 0;
	  var AddedLayer = "";
	  
		parser.parse();
	    var symbol = new SimpleMarkerSymbol(
          SimpleMarkerSymbol.STYLE_CIRCLE, 
          12, 
          new SimpleLineSymbol(
            SimpleLineSymbol.STYLE_NULL, 
            new Color([247, 34, 101, 0.9]), 
            1
          ),
          new Color([207, 34, 171, 0.5])
        );

		
		var latFieldStrings = ["lat", "latitude", "y", "ycenter"];
		var longFieldStrings = ["lon", "long", "longitude", "x", "xcenter"];
		
		esriConfig.defaults.io.corsEnabledServers.push("serverapi.arcgisonline.com");
		esriConfig.defaults.io.proxyUrl = 'http://serverapi.arcgisonline.com/proxy/proxy.ashx';
		///////////////////////// Create the Map //////////////////////////////////////////////////////////////
        map = new Map("mapCanvas", {
          basemap: "dark-gray",  
          center: [-95.45, 37.75],
          zoom: 4
        });
	//////////////////////////// Add Layers //////////////////////////////////////////////////////////
		var ft6 = new ArcGISTiledMapServiceLayer("http://coast.noaa.gov/arcgis/rest/services/dc_slr/slr_6ft/MapServer",{
			visible: false
			});
		var ft6select = new FeatureLayer("http://gis.brevardcounty.us/gissrv/rest/services/Base_Map/General_WKID102100/MapServer/5",{
			mode: FeatureLayer.MODE_ONDEMAND,
			visible: true
			});
		var ft5 = new ArcGISTiledMapServiceLayer("http://coast.noaa.gov/arcgis/rest/services/dc_slr/slr_5ft/MapServer",{
			visible: false
			});
		var ft4 = new ArcGISTiledMapServiceLayer("http://coast.noaa.gov/arcgis/rest/services/dc_slr/slr_4ft/MapServer",{
			visible: false
			});
		var ft3 = new ArcGISTiledMapServiceLayer("http://coast.noaa.gov/arcgis/rest/services/dc_slr/slr_3ft/MapServer",{
			visible: false
			});
		var ft2 = new FeatureLayer("http://coast.noaa.gov/arcgis/rest/services/FloodExposureMapper/CFEM_SeaLevelRise/MapServer/16",{
			visible: false
			});
		var ft1 = new ArcGISTiledMapServiceLayer("http://coast.noaa.gov/arcgis/rest/services/FloodExposureMapper/CFEM_SeaLevelRise/MapServer",{
			visible: false
			});
		map.addLayers([ft6,ft5,ft4,ft3,ft2,ft1,ft6select] );
		ft6select.setSelectionSymbol(symbol); 
		var queryTask = new QueryTask("http://gis.brevardcounty.us/gissrv/rest/services/Base_Map/General_WKID102100/MapServer/5");

		/////////////////// Create the Legend ///////////////////////////////////////////////////////////////////////////////////
		map.on('layers-add-result', legenddoit);
		function legenddoit(evt){
		if ( AddedLayer == "") {
			var LegendLayers = [{
					layer: ft1,
                    title: "Inundation from Sea Level Rise (1ft)",
					collapse: true
					//slider: true
                },{
					layer: ft2,
                    title: "Inundation from Sea Level Rise (2ft)"
					//collapse: true
                },{
					layer: ft3,
                    title: "Inundation from Sea Level Rise (3ft)",
					collapse: true
                },{
					layer: ft4,
                    title: "Inundation from Sea Level Rise (4ft)",
					collapse: true
                },{
					layer: ft5,
                    title: "Inundation from Sea Level Rise (5ft)",
					collapse: true
                },{
					layer: ft6,
                    title: "Inundation from Sea Level Rise (6ft)",
					collapse: true
                }];

			toc = new TOC({
				map: map,
                layerInfos: LegendLayers
            }, 'tocDiv');
            toc.startup();
			} else {
				var MyName = NewLayer.name;
				var currentDiv = currentLayer;
				var LegendLayers = [{
					layer: NewLayer,
                    title: MyName,
					collapse: true
				},{
					layer: ft1,
                    title: "Inundation from Sea Level Rise (1ft)",
					collapse: true
					//slider: true
                },{
					layer: ft2,
                    title: "Inundation from Sea Level Rise (2ft)",
					collapse: true				
                },{
					layer: ft3,
                    title: "Inundation from Sea Level Rise (3ft)",
					collapse: true
                }, {
					layer: ft4,
                    title: "Inundation from Sea Level Rise (4ft)",
					collapse: true
                },{
					layer: ft5,
                    title: "Inundation from Sea Level Rise (5ft)",
					collapse: true
                },{
					layer: ft6,
                    title: "Inundation from Sea Level Rise (6ft)",
					collapse: true
                }];
				toc2 = new TOC({
				map: map,
                layerInfos: LegendLayers
            }, currentDiv );
            toc2.startup();
			var addedExtent = evt.layers[0].layer.fullExtent;
			map.setExtent(addedExtent);
			console.log("test");
 

		
			}
        };
		
		/////////////////////// Create the Add Layer Button /////////////////////////////////
		var myButton = new Button({
			label: "Add Layer",
			onClick: function(){
				click += 1;
				previouseDiv = currentDiv;
				previouseLayer = currentLayer;
				currentLayer = "layer" + click;
				console.log(currentLayer);
				if (NewLayer !== undefined){
					console.log(NewLayer);
					map.removeLayer(NewLayer);
				}
				currentDiv = "<div id=" + currentLayer +">";
				NeededValue = dom.byId("myURL").value;
				console.log(NeededValue);
				NewLayer = new FeatureLayer(NeededValue,{
					mode: FeatureLayer.MODE_ONDEMAND,
					outFields: ['*']
				});
				var MyName = NewLayer.name;
				map.addLayers([NewLayer]);
				AddedLayer = "Gotem";
				if (currentLayer == "layer1"){
					domConstruct.place(currentDiv  + "<div>", 'tocDiv',"replace");
				} else {
				domConstruct.place(currentDiv + "<div>", previouseLayer,"replace");
				}
				
					//var query = new Query();

				//query.where = "1=1";
				
			
				

				//ft6select.queryFeatures(query, selectInBuffer);
		
				//function selectInBuffer (evt){
					///var feature; 
					//var features = evt.features;  
					//var inBuffer = [];
					
					   // for (var i = 0; i < features.length; i++) {  
						//	feature = features[i];  
							 
             
							//TODO: if the feature.geometry is point then buffer the point here               
							//inBuffer.push(feature.geometry);             
							         
						//}  
					
					//console.log(evt);
					//var query2 = new Query();   
					//var tested = geometryEngine.union(inBuffer);
					//query2.geometry = tested;
					//console.log("tut");
					
					//NewLayer.queryFeatures(query2, function(results){             
					//	console.log(results);
					//});     
					//}
	
}	
				
		}, "progButtonNode").startup();
		
			
		var myButton2 = new Button({
			label: "Analize",
			onClick: function(){
				selectedCity = [];
				var allPoints = [];
				var mp = new Multipoint();  
					arrayUtils.map(NewLayer.graphics, function(gra){  
						mp.addPoint(gra.geometry);  
						allPoints.push(gra);
					});  
					console.log(mp);
					console.log(allPoints);
					//var queryTask = new QueryTask("http://gis.brevardcounty.us/gissrv/rest/services/Base_Map/General_WKID102100/MapServer/5");
					var query = new Query();
					//for (var i = 0; i < allPoints.length; i++) {
							//query.geometry = allPoints[i].geometry;
						//	ft6select.selectFeatures(query,FeatureLayer.SELECTION_ADD, function(evt2){
								//if(evt2.length > 0){
								//	var tutu = evt2[0].geometry;
								//	selectedCity.push(tutu);
								//}
							//	console.log(selectedCity);
							//});
					
						//}

					//query.geometry = allPoints[0].geometry;
					query.geometry = mp;
					query.spatialRelationship = Query.SPATIAL_REL_CROSSES;
					//queryTask.execute(query);
					ft6select.selectFeatures(query);

				
			}	
				
		}, "progButtonNode2").startup();
		
		map.on('click', function(evt){
			mapPoint = evt.mapPoint;
			ft6select.clearSelection();
			var query = new Query();
			query.geometry = mapPoint;
			ft6select.selectFeatures(query);

		});

				
				ft6select.on('selection-complete', function (evt){
					console.log(evt);
				});
      });
    </script>
  </head>

  <body class ="claro">
	<div id="borderContainer" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline', gutters:true, liveSplitters:true">
		<div id="mapCanvas" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="splitter:true, region:'center'">

		</div>
		<div id="bottomPane" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="splitter:true, region:'bottom'">
		 <label for="firstname">Add a layer:</label>
			<input type="text" name="myURL" style="width: 50em;" value="http://gis.brevardcounty.us/gissrv/rest/services/Library/Location_WKID102100/MapServer/0"
				data-dojo-type="dijit/form/TextBox"
				data-dojo-props="trim:true, propercase:true" id="myURL" />
			<button id="progButtonNode" type="button"></button><div id="result1"></div>
		</div>
		<div id="leftPane" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'leading'">
			<div data-dojo-type="dijit/layout/AccordionContainer" style="height: 300px;">
				<div data-dojo-type="dijit/layout/ContentPane" title="Legend" selected="true">
				<div id ="LegendInHere">
				  <div id="tocDiv">
				</div>
                </div>

				</div>
				<div data-dojo-type="dijit/layout/ContentPane" title="Analysis">
				<div id="tocDiv2">
				<button id="progButtonNode2" type="button"></button>
                </div>
				</div>
			</div>
		</div>
	</div>	
  </body>
</html>